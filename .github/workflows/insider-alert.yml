name: Insider Alerts (WhatsApp)

on:
  workflow_dispatch: {}           # handmatig starten mogelijk
  schedule:
    - cron: "*/30 * * * *"        # elke 30 minuten

jobs:
  alert:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Installeer dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install twilio

      - name: Toon repo layout (debug)
        run: |
          set -euo pipefail
          echo "== TOP =="
          ls -l
          echo "== scripts =="
          ls -l scripts || true

      - name: Draai insider pipeline (dummy scripts ok)
        run: |
          set -euo pipefail
          python scripts/fetch_insiders.py
          python scripts/score_signals.py
          python scripts/fetch_news.py
          python scripts/report_builder.py

      - name: Detecteer nieuwe signalen & bouw samenvatting
        id: find_report
        run: |
          echo "Samenvatting=Insider pipeline succesvol gedraaid" >> "$GITHUB_OUTPUT"

      - name: Stuur WhatsApp via Twilio (alleen bij alert)
        if: always()
        env:
          TWILIO_SID:         ${{ secrets.TWILIO_SID }}
          TWILIO_AUTH_TOKEN:  ${{ secrets.TWILIO_AUTH_TOKEN }}
          WHATSAPP_TO:        ${{ secrets.WHATSAPP_TO }}
        run: |
          python - <<'PY'
          import os
          from twilio.rest import Client

          sid   = os.getenv("TWILIO_SID")
          token = os.getenv("TWILIO_AUTH_TOKEN")
          to    = os.getenv("WHATSAPP_TO")

          if not sid or not token or not to:
              raise SystemExit("Twilio secrets ontbreken (TWILIO_SID / TWILIO_AUTH_TOKEN / WHATSAPP_TO)")

          body = "âœ… Insider Monitor: nieuwe run voltooid."
          client = Client(sid, token)
          msg = client.messages.create(
              from_="whatsapp:+14155238886",  # Twilio Sandbox
              to=to,
              body=body
          )
          print("WhatsApp verzonden, SID:", msg.sid)
          PY

      - name: Upload rapporten (optioneel)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: reports
          path: data/reports/
