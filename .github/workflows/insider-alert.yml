name: Insider Alerts (WhatsApp) â€” DEBUG

on:
  workflow_dispatch: {}        # handmatig 'Run workflow' zichtbaar
  schedule:
    - cron: "0 * * * *"        # elk uur; mag je weghalen tijdens testen

jobs:
  alert:
    runs-on: ubuntu-latest

    env:
      # Vereist in repo secrets:
      # - TWILIO_ACCOUNT_SID
      # - TWILIO_AUTH_TOKEN
      # - ALERT_TO_INSIDER   (bijv. "whatsapp:+31XXXXXXXXX")
      TWILIO_ACCOUNT_SID: ${{ secrets.TWILIO_ACCOUNT_SID }}
      TWILIO_AUTH_TOKEN:  ${{ secrets.TWILIO_AUTH_TOKEN }}
      ALERT_TO_INSIDER:   ${{ secrets.ALERT_TO_INSIDER }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Installeer Twilio SDK
        run: |
          python -m pip install --upgrade pip
          pip install twilio

      - name: Stuur WhatsApp test (altijd, debug)
        # Dit stuurt ALTIJD een bericht, ongeacht data/alerts
        run: |
          python - <<'PY'
          import os, datetime
          from twilio.rest import Client

          sid   = os.environ.get("TWILIO_ACCOUNT_SID")
          token = os.environ.get("TWILIO_AUTH_TOKEN")
          to    = os.environ.get("ALERT_TO_INSIDER")

          # Basis sanity checks (voorkomt 'None' fouten)
          missing = [k for k,v in {"TWILIO_ACCOUNT_SID":sid,"TWILIO_AUTH_TOKEN":token,"ALERT_TO_INSIDER":to}.items() if not v]
          if missing:
              raise SystemExit(f"Ontbrekende secrets: {', '.join(missing)}")

          client = Client(sid, token)

          ts = datetime.datetime.utcnow().strftime("%Y-%m-%d %H:%M:%S UTC")
          body = (
              "ðŸš¨ *Insider Monitor â€“ DEBUG*\n"
              f"De keten werkt! ({ts})\n\n"
              "Als je dit bericht ontvangt, is Twilio WhatsApp OK âœ…\n"
              "â€” Repo: insider-monitor\n"
              "â€” Workflow: insider-alert.yml"
          )

          msg = client.messages.create(
              body=body,
              from_="whatsapp:+14155238886",  # Twilio Sandbox afzender
              to=to
          )
          print("WhatsApp verzonden, SID:", msg.sid)
          PY

      - name: Klaar
        run: echo "Debug-WhatsApp verzonden (als secrets & sandbox goed staan)."
