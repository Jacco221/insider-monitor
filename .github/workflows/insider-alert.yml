name: Insider Alerts (Insider Monitor only)

on:
  workflow_dispatch: {}           # handmatig Run workflow
  schedule:
    - cron: "*/30 * * * *"        # elke 30 minuten

jobs:
  alert:
    runs-on: ubuntu-latest

    # Alle 'run' stappen draaien standaard in insider-monitor/
    defaults:
      run:
        shell: bash
        working-directory: insider-monitor

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Installeer dependencies (alleen Insider Monitor)
        run: |
          set -e
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt || true
          fi
          # Minimalen die vaak nuttig zijn
          pip install twilio pyyaml requests || true

      - name: Debug: toon insider-monitor layout
        run: |
          echo "== insider-monitor top =="
          ls -la
          echo "== insider-monitor/scripts =="
          ls -la scripts || true
          echo "== insider-monitor/data/reports =="
          ls -la data/reports || true

      - name: Draai EEN insider script
        id: runjob
        run: |
          set -euo pipefail
          summary="⚠️ Geen bekend Insider Monitor script gevonden."
          exit_code=0

          if [ -f scripts/build_scores.py ]; then
            echo "Running: scripts/build_scores.py"
            python scripts/build_scores.py || exit_code=$?
            summary="✅ Insider: scripts/build_scores.py (exit $exit_code)."
          elif [ -f run.py ]; then
            echo "Running: run.py"
            python run.py || exit_code=$?
            summary="✅ Insider: run.py (exit $exit_code)."
          elif [ -f scripts/pull_reports.sh ]; then
            echo "Running: scripts/pull_reports.sh"
            bash scripts/pull_reports.sh || exit_code=$?
            summary="✅ Insider: scripts/pull_reports.sh (exit $exit_code)."
          else
            echo "⚠️ Niets gevonden in insider-monitor/ (verwacht: scripts/build_scores.py of run.py of scripts/pull_reports.sh)."
          fi

          {
            echo "summary<<EOF"
            echo "$summary"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Upload rapporten (optioneel)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: insider-reports
          path: |
            insider-monitor/data/reports/**
            insider-monitor/data/reports/*.csv
            insider-monitor/data/reports/*.md
          if-no-files-found: ignore

      - name: Stuur WhatsApp via Twilio (optioneel)
        if: always()
        env:
          TWILIO_ACCOUNT_SID: ${{ secrets.TWILIO_ACCOUNT_SID }}
          TWILIO_AUTH_TOKEN: ${{ secrets.TWILIO_AUTH_TOKEN }}
          ALERT_TO_INSIDER: ${{ secrets.ALERT_TO_INSIDER }}
          SUMMARY: ${{ steps.runjob.outputs.summary }}
        run: |
          python - <<'PY'
          import os, sys
          sid = os.getenv('TWILIO_ACCOUNT_SID')
          token = os.getenv('TWILIO_AUTH_TOKEN')
          to = os.getenv('ALERT_TO_INSIDER')  # bijv. whatsapp:+316XXXXXXXX

          if not sid or not token or not to:
              print("ℹ️ Twilio-secrets ontbreken; WhatsApp stap overgeslagen.")
              sys.exit(0)

          from twilio.rest import Client
          body = os.getenv('SUMMARY') or "Insider Monitor pipeline is gedraaid."
          try:
              client = Client(sid, token)
              msg = client.messages.create(
                  from_='whatsapp:+14155238886',  # Twilio sandbox zender
                  to=to,
                  body=f"Insider Monitor: {body}"
              )
              print("✅ WhatsApp verzonden, SID:", msg.sid)
          except Exception as e:
              print("⚠️ Fout bij WhatsApp:", e)
              sys.exit(0)   # notificatie-fout mag de run niet laten falen
          PY
