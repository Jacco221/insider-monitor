name: Insider Alerts (WhatsApp)

on:
  workflow_dispatch: {}       # handmatig starten via Actions-tab
  schedule:
    - cron: "*/30 * * * *"    # elke 30 minuten

jobs:
  alert:
    env:
      SEC_USER_AGENT: ${{ secrets.SEC_USER_AGENT }}
      TWILIO_ACCOUNT_SID: ${{ secrets.TWILIO_ACCOUNT_SID }}
      TWILIO_AUTH_TOKEN: ${{ secrets.TWILIO_AUTH_TOKEN }}
      ALERT_TO_INSIDER: ${{ secrets.ALERT_TO_INSIDER }}

    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Installeer dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Toon repo layout (debug)
        run: |
          ls -R

      - name: Zoek scripts map
        run: |
          if [ ! -d scripts ]; then
            echo "‚ùå Map 'scripts' ontbreekt"
            exit 1
          fi
          echo "‚úÖ Scripts map gevonden"

      - name: Draai insider pipeline
        run: |
          python scripts/fetch_insiders.py
          python scripts/score_signals.py
          python scripts/fetch_news.py
          python scripts/report_builder.py

      - name: Detecteer nieuwe signalen & bouw samenvatting
        run: |
          echo "Samenvatting:"
          cat reports/summary_*.txt || echo "‚ö†Ô∏è Geen rapport gevonden"

      - name: Stuur WhatsApp via Twilio (alleen bij alert)
        if: always()
        run: |
          python - <<'PY'
          import os
          from twilio.rest import Client
          rep_dir = "reports"
          from pathlib import Path

          sid = os.environ["TWILIO_ACCOUNT_SID"]
          token = os.environ["TWILIO_AUTH_TOKEN"]
          to = os.environ["ALERT_TO_INSIDER"]

          client = Client(sid, token)

          reports = sorted(Path(rep_dir).glob("summary_*.txt"))
          if not reports:
              print("Geen rapport om te versturen")
              raise SystemExit(0)

          latest = reports[-1].read_text(encoding="utf-8")
          if "insider" in latest.lower():
              msg = client.messages.create(
                  body=f"Insider Alert üö®\n\n{latest[:1000]}",
                  from_="whatsapp:+14155238886",
                  to=f"whatsapp:{to}"
              )
              print("WhatsApp verstuurd:", msg.sid)
          else:
              print("Geen insider alerts gevonden.")
          PY

      - name: Upload rapporten (optioneel)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: reports
          path: reports/
