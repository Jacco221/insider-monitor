name: Insider Alerts (WhatsApp)

on:
  workflow_dispatch:

jobs:
  alert:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Installeer dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install twilio

      - name: Toon repo layout (debug)
        run: ls -R

      - name: Zoek scripts map (fail fast)
        run: test -d scripts

      - name: Draai insider pipeline (dummy ok)
        run: |
          python scripts/fetch_insiders.py || true
          python scripts/score_signals.py || true
          python scripts/fetch_news.py || true
          python scripts/report_builder.py || true

      - name: Detecteer nieuwe signalen & bouw samenvatting
        run: |
          echo "== Laatste rapport =="
          ls -lh data/reports || true
          tail -50 data/reports/latest.txt || true

      - name: Stuur WhatsApp via Twilio (debug: altijd sturen)
        env:
          TWILIO_ACCOUNT_SID: ${{ secrets.TWILIO_ACCOUNT_SID }}
          TWILIO_AUTH_TOKEN: ${{ secrets.TWILIO_AUTH_TOKEN }}
          ALERT_TO_INSIDER: ${{ secrets.ALERT_TO_INSIDER }}
        run: |
          python - <<'PY'
          import os
          from twilio.rest import Client

          sid = os.environ["TWILIO_ACCOUNT_SID"]
          tok = os.environ["TWILIO_AUTH_TOKEN"]
          to = os.environ["ALERT_TO_INSIDER"]

          client = Client(sid, tok)

          body = "ðŸš¨ Insider Monitor testbericht: dit is een DEBUG push met nieuws!"

          msg = client.messages.create(
              body=body,
              from_="whatsapp:+14155238886",
              to=f"whatsapp:{to}"
          )

          print("WhatsApp verzonden! SID:", msg.sid)
          PY

      - name: Upload rapporten (optioneel)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: reports
          path: |
            data/reports/latest.txt
            data/reports/summary_*.txt
          if-no-files-found: ignore
