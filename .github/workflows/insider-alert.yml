name: Insider Alerts (WhatsApp)

on:
  workflow_dispatch:
    inputs:
      debug_whatsapp:
        description: 'Forceer WhatsApp (debug)'
        required: false
        default: 'true'   # zet op 'false' als je geen debug wilt
  schedule:
    - cron: "*/30 * * * *"

jobs:
  alert:
    runs-on: ubuntu-latest

    env:
      SEC_USER_AGENT: ${{ secrets.SEC_USER_AGENT }}
      TWILIO_ACCOUNT_SID: ${{ secrets.TWILIO_ACCOUNT_SID }}
      TWILIO_AUTH_TOKEN: ${{ secrets.TWILIO_AUTH_TOKEN }}
      WHATSAPP_TO: ${{ secrets.ALERT_TO_INSIDER }}
      DEBUG_WHATSAPP: ${{ github.event.inputs.debug_whatsapp }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Installeer dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests lxml beautifulsoup4 twilio

      - name: Toon repo layout (debug)
        run: ls -lah

      - name: Zoek scripts map (fail fast)
        run: |
          set -euo pipefail
          echo "== ZOEK SCRIPTS =="
          if [ -d scripts ]; then
            echo "OK: ./scripts"
          else
            echo "FOUT: geen 'scripts' map"; exit 1
          fi
          ls -lah scripts

      - name: Draai insider pipeline
        run: |
          set -euo pipefail
          export SEC_USER_AGENT="${SEC_USER_AGENT}"

          echo "== FETCH insiders (SEC) =="
          python scripts/fetch_insiders.py

          echo "== SCORE signals =="
          python scripts/score_signals.py

          echo "== FETCH news (dummy) =="
          python scripts/fetch_news.py

          echo "== BUILD report =="
          python scripts/report_builder.py

          echo "== Laatste files =="
          ls -lah data/reports || true
          tail -50 data/reports/latest.txt || true

      - name: Detecteer nieuwe signalen & bouw samenvatting
        id: find_report
        shell: bash
        run: |
          set -euo pipefail
          if [ -f data/reports/latest.txt ]; then
            echo "found=true" >> $GITHUB_OUTPUT
          else
            echo "found=false" >> $GITHUB_OUTPUT
          fi

      - name: Stuur WhatsApp via Twilio (alleen bij alert, of altijd in debug)
        if: steps.find_report.outputs.found == 'true'
        run: |
          python - <<'PY'
          import os, sys
          from twilio.rest import Client
          from pathlib import Path

          sid  = os.environ.get("TWILIO_ACCOUNT_SID")
          tok  = os.environ.get("TWILIO_AUTH_TOKEN")
          to   = os.environ.get("WHATSAPP_TO")
          debug = (os.environ.get("DEBUG_WHATSAPP","").lower() == "true")

          if not all([sid, tok, to]):
            raise SystemExit("Twilio secrets ontbreken (TWILIO_ACCOUNT_SID / TWILIO_AUTH_TOKEN / ALERT_TO_INSIDER)")

          latest = Path("data/reports/latest.txt").read_text(encoding="utf-8")
          # “signal aanwezig?” check: heel simpel — komt het woord 'insider' voor
          is_insider = (" insider " in (" " + latest.lower() + " "))

          # Als debug, dan altijd sturen. Anders alleen bij insider.
          if debug or is_insider:
            head = "\n".join(latest.strip().splitlines()[:12])  # compact
            prefix = "[DEBUG]" if debug and not is_insider else "ALERT"
            body = f"{prefix} Insider Alert\n\n{head}\n\n—\n(insider-monitor)"
            print("Verzend WhatsApp...")
            Client(sid, tok).messages.create(
              from_="whatsapp:+14155238886",
              to=to,
              body=body
            )
            print("OK: WhatsApp verzonden.")
          else:
            print("Geen insider signal (en debug=false) — geen WhatsApp verstuurd.")
          PY

      - name: Upload rapporten (optioneel)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: reports
          path: data/reports
          if-no-files-found: warn
